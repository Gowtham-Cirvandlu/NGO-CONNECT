{% extends "base.html" %}
{% block title %}Admin Audit Logs - NGO Connect{% endblock %}
{% block content %}
<div class="min-h-screen bg-gradient-to-br from-purple-50 via-white to-blue-50 pt-24 pb-12">
  <div class="container mx-auto px-6">
    <div class="border-0 shadow-lg rounded-xl bg-white p-6 mb-6">
      <h1 class="text-2xl font-semibold text-[#1F2B5B]">Audit Logs</h1>
      <p class="text-gray-600">Review recent admin activities</p>
    </div>

    <div class="border-0 shadow-lg rounded-xl bg-white overflow-hidden" id="logsCard">
      <div class="p-4 border-b">
        <form class="grid md:grid-cols-4 gap-3 js-admin-filter" method="get" data-target="#logsSection">
          <input name="admin" value="{{ admin_filter or '' }}" placeholder="Admin ID" class="border rounded-lg px-3 py-2" />
          <input name="action" value="{{ action_filter or '' }}" placeholder="Action" class="border rounded-lg px-3 py-2" />
          <input type="date" name="date_from" value="{{ date_from or '' }}" class="border rounded-lg px-3 py-2" />
          <input type="date" name="date_to" value="{{ date_to or '' }}" class="border rounded-lg px-3 py-2" />
          <div class="md:col-span-4 flex items-center gap-3 flex-wrap">
            <button class="mt-2 px-4 py-2 rounded-full bg-[#A855F7] text-white" type="submit">Filter</button>
            <a href="{{ url_for('admin_audit_logs') }}" class="mt-2 text-sm text-[#1F2B5B] underline js-filter-clear">Clear all</a>
          </div>
        </form>
        <div class="mt-4 grid md:grid-cols-5 gap-3 items-end">
          <div class="md:col-span-2">
            <label class="block text-sm text-gray-600 mb-1">Clear mode</label>
            <select class="border rounded-lg px-3 py-2 w-full" id="clearMode">
              <option value="older_than">Older than date</option>
              <option value="range">Between dates (inclusive)</option>
            </select>
          </div>
          <div>
            <label class="block text-sm text-gray-600 mb-1">Cutoff / From</label>
            <input type="date" class="border rounded-lg px-3 py-2 w-full" id="clearFrom">
          </div>
          <div>
            <label class="block text-sm text-gray-600 mb-1">To (for range)</label>
            <input type="date" class="border rounded-lg px-3 py-2 w-full" id="clearTo">
          </div>
          <div class="md:col-span-1">
            <form method="POST" action="{{ url_for('admin_clear_audit_logs') }}" id="clearForm" class="flex items-end">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input type="hidden" name="mode" value="older_than">
              <input type="hidden" name="cutoff_date" value="">
              <input type="hidden" name="date_from" value="">
              <input type="hidden" name="date_to" value="">
              <button type="submit" class="mt-2 px-4 py-2 rounded-full bg-red-600 text-white">Delete Logs</button>
            </form>
          </div>
        </div>
      </div>
      <div id="logsSection">
      <div class="px-6 pt-3 pb-0 js-ajax-area">
        {% if admin_filter or action_filter or date_from or date_to %}
        <div class="flex items-center flex-wrap gap-2 mb-3">
          {% if admin_filter %}<a href="{{ url_for('admin_audit_logs', action=action_filter or None, date_from=date_from or None, date_to=date_to or None) }}" class="px-3 py-1 rounded-full bg-gray-100 text-gray-700 text-sm js-filter-chip">Admin: {{ admin_filter }} <span class="ml-1 text-gray-500">×</span></a>{% endif %}
          {% if action_filter %}<a href="{{ url_for('admin_audit_logs', admin=admin_filter or None, date_from=date_from or None, date_to=date_to or None) }}" class="px-3 py-1 rounded-full bg-gray-100 text-gray-700 text-sm js-filter-chip">Action: {{ action_filter }} <span class="ml-1 text-gray-500">×</span></a>{% endif %}
          {% if date_from or date_to %}<a href="{{ url_for('admin_audit_logs', admin=admin_filter or None, action=action_filter or None) }}" class="px-3 py-1 rounded-full bg-gray-100 text-gray-700 text-sm js-filter-chip">Date: {{ date_from or '...' }} — {{ date_to or '...' }} <span class="ml-1 text-gray-500">×</span></a>{% endif %}
        </div>
        {% endif %}
      </div>
      <div class="overflow-x-auto">
        <table class="table w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="text-left text-xs font-semibold text-gray-600 uppercase tracking-wide py-3 px-4">Time</th>
              <th class="text-left text-xs font-semibold text-gray-600 uppercase tracking-wide py-3 px-4">Admin</th>
              <th class="text-left text-xs font-semibold text-gray-600 uppercase tracking-wide py-3 px-4">Action</th>
              <th class="text-left text-xs font-semibold text-gray-600 uppercase tracking-wide py-3 px-4">Resource</th>
              <th class="text-left text-xs font-semibold text-gray-600 uppercase tracking-wide py-3 px-4">Success</th>
            </tr>
          </thead>
          <tbody>
            {% for log in logs.items if logs and logs.items %}
            <tr>
              <td class="py-3 px-4">{{ log.timestamp.strftime('%Y-%m-%d %H:%M') if log.timestamp else '' }}</td>
              <td class="py-3 px-4">{{ log.admin_user_id }}</td>
              <td class="py-3 px-4">{{ log.action }}</td>
              <td class="py-3 px-4">{{ log.resource_type }} {{ log.resource_id or '' }}</td>
              <td class="py-3 px-4">{{ 'Yes' if log.success else 'No' }}</td>
            </tr>
            {% else %}
            <tr><td colspan="5" class="py-4 px-4 text-gray-500">No logs</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% if logs %}
      <div class="p-4 flex items-center justify-between text-sm text-gray-600 js-ajax-area">
        <div>Page {{ logs.page }} of {{ logs.pages }}</div>
        <div class="pagination">
          {% if logs.has_prev %}<a href="?page={{ logs.prev_num }}&admin={{ admin_filter }}&action={{ action_filter }}&date_from={{ date_from }}&date_to={{ date_to }}">Prev</a>{% endif %}
          {% if logs.has_next %}<a href="?page={{ logs.next_num }}&admin={{ admin_filter }}&action={{ action_filter }}&date_from={{ date_from }}&date_to={{ date_to }}">Next</a>{% endif %}
        </div>
      </div>
      {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
(function(){
  var ajaxBusy = false;
  function setSkeleton(target){
    var tbl = target.querySelector('tbody');
    if(!tbl) return;
    tbl.innerHTML = '';
    for(var i=0;i<6;i++){
      var tr = document.createElement('tr'); tr.className='skeleton-row';
      tr.innerHTML = '<td><span class="skeleton-box lg"></span></td>'+
                     '<td><span class="skeleton-box"></span></td>'+
                     '<td><span class="skeleton-box sm"></span></td>'+
                     '<td><span class="skeleton-box sm"></span></td>'+
                     '<td><span class="skeleton-box sm"></span></td>';
      tbl.appendChild(tr);
    }
  }
  function swapWrap(fromHtml, wrapSelector){
    var parser = new DOMParser();
    var doc = parser.parseFromString(fromHtml, 'text/html');
    var newWrap = doc.querySelector(wrapSelector);
    var curWrap = document.querySelector(wrapSelector);
    if(newWrap && curWrap){ curWrap.innerHTML = newWrap.innerHTML; return true; }
    return false;
  }
  function toast(msg, level){
    var container = document.getElementById('toastContainer');
    if(!container) return;
    var el = document.createElement('div');
    el.className = 'toast toast-' + (level||'info');
    el.innerHTML = '<i class="fas ' + (level==='success'?'fa-check-circle':(level==='error'?'fa-exclamation-circle':'fa-info-circle')) + ' toast-icon"></i>'+ '<div>'+ msg +'</div>' + '<button class="toast-close" aria-label="Close">&times;</button>';
    el.querySelector('.toast-close').addEventListener('click', function(){ el.remove(); });
    container.appendChild(el);
    setTimeout(function(){ el.remove(); }, 4000);
  }
  document.addEventListener('DOMContentLoaded', function(){
    var csrf = (document.querySelector('meta[name="csrf-token"]')||{}).getAttribute ? document.querySelector('meta[name="csrf-token"]').getAttribute('content') : '';
    // Filters
    document.querySelectorAll('.js-admin-filter').forEach(function(form){
      form.addEventListener('submit', function(e){
        e.preventDefault();
        if(ajaxBusy) return;
        var targetSel = form.getAttribute('data-target') || '#logsSection';
        var target = document.querySelector(targetSel);
        if(target) setSkeleton(target);
        var params = new URLSearchParams(new FormData(form));
        var url = window.location.pathname + '?' + params.toString();
        var submitBtn = form.querySelector('button[type="submit"]');
        if(submitBtn){ submitBtn.disabled = true; submitBtn.classList.add('opacity-50','pointer-events-none'); }
        ajaxBusy = true;
        fetch(url, { headers: { 'X-Requested-With':'XMLHttpRequest', 'X-CSRFToken': csrf } })
          .then(function(r){ return r.text(); })
          .then(function(html){ if(!swapWrap(html, targetSel)){ window.location.href = url; return; } history.replaceState(null, '', url); })
          .catch(function(){})
          .finally(function(){ ajaxBusy = false; if(submitBtn){ submitBtn.disabled = false; submitBtn.classList.remove('opacity-50','pointer-events-none'); } });
      });
    });
    // Pagination via AJAX (robust) and chips
    document.body.addEventListener('click', function(ev){
      var a = ev.target.closest('.pagination a, .js-filter-chip, .js-filter-clear');
      if(!a) return;
      var wrapSel = a.closest('#logsCard') ? '#logsSection' : null;
      if(!wrapSel) return;
      ev.preventDefault();
      if(ajaxBusy) return;
      var target = document.querySelector(wrapSel);
      if(target) setSkeleton(target);
      ajaxBusy = true;
      var url = a.href;
      // Disable pagination links while loading
      document.querySelectorAll('#logsSection .pagination a').forEach(function(link){ link.classList.add('opacity-50','pointer-events-none'); });
      fetch(url, { headers: { 'X-Requested-With':'XMLHttpRequest', 'X-CSRFToken': csrf } })
        .then(function(r){ return r.text(); })
        .then(function(html){ if(!swapWrap(html, wrapSel)){ window.location.href = url; return; } history.replaceState(null, '', url); })
        .catch(function(){})
        .finally(function(){ ajaxBusy = false; document.querySelectorAll('#logsSection .pagination a').forEach(function(link){ link.classList.remove('opacity-50','pointer-events-none'); }); });
    });
    // Clear form wiring
    var clearMode = document.getElementById('clearMode');
    var clearFrom = document.getElementById('clearFrom');
    var clearTo = document.getElementById('clearTo');
    var clearForm = document.getElementById('clearForm');
    if(clearForm){
      clearForm.addEventListener('submit', function(e){
        // Fill hidden fields from selectors
        clearForm.querySelector('input[name="mode"]').value = (clearMode && clearMode.value) || 'older_than';
        clearForm.querySelector('input[name="cutoff_date"]').value = clearFrom ? clearFrom.value : '';
        clearForm.querySelector('input[name="date_from"]').value = clearFrom ? clearFrom.value : '';
        clearForm.querySelector('input[name="date_to"]').value = clearTo ? clearTo.value : '';
        // If using AJAX
        if (window.fetch){
          e.preventDefault();
          var fd = new FormData(clearForm);
          if(ajaxBusy) return; ajaxBusy = true;
          fetch(clearForm.action, { method: 'POST', headers: { 'X-Requested-With':'XMLHttpRequest', 'X-CSRFToken': csrf }, body: fd })
            .then(function(r){ return r.json().then(function(j){ return { ok:r.ok, data:j }; }); })
            .then(function(res){
              if(res.ok && res.data && res.data.success){ toast('Deleted '+res.data.deleted+' log(s).','success');
                // Reload current table via AJAX
                var params = new URLSearchParams(window.location.search);
                var url = window.location.pathname + (params.toString() ? ('?'+params.toString()) : '');
                fetch(url, { headers: { 'X-Requested-With':'XMLHttpRequest', 'X-CSRFToken': csrf } })
                  .then(function(r){ return r.text(); })
                  .then(function(html){ swapWrap(html, '#logsSection'); });
              } else { toast((res.data && res.data.error) || 'Failed to delete logs','error'); }
            }).catch(function(){ toast('Network error','error'); })
            .finally(function(){ ajaxBusy = false; });
        }
      });
    }
  });
})();
</script>
{% endblock %}
