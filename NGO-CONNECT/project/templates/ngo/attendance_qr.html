{% extends "base.html" %}
{% block title %}Attendance QR - {{ event.title }} - NGO Connect{% endblock %}
{% block content %}
<section class="container" style="max-width: 900px;" data-event-id="{{ event.id }}" data-time-slot-id="{{ time_slot.id if time_slot else '' }}">
    <div class="card card-elevated">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">
                        <i class="fas fa-qrcode text-primary me-2"></i>Attendance QR
                    </h1>
                    <p class="text-muted mb-0">Generate QR codes for volunteer check-ins</p>
                </div>
                <a href="{{ url_for('ngo_view_event', event_id=event.id) }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Event
                </a>
            </div>
        </div>
        
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-6 text-center">
                    <div class="mb-4">
                        <h4 class="mb-3">Scan to Check-in</h4>
                        <div id="qr-box" class="mx-auto" style="width: 280px; height: 280px; background: #f8f9fa; border-radius: 12px; display: flex; align-items: center; justify-content: center; border: 2px dashed #dee2e6;">
                            <div id="qr-canvas" style="width: 260px; height: 260px;"></div>
                            <img id="qr-img" alt="QR Code" class="img-fluid d-none" style="max-width: 90%; max-height: 90%;" />
                        </div>
                        <div class="mt-3">
                            <p class="text-muted small mb-2">
                                Token expires in <span id="ttl" class="fw-bold text-primary">--</span> seconds
                            </p>
                            <button class="btn btn-primary btn-sm" id="btn-refresh">
                                <i class="fas fa-sync-alt me-1"></i>Refresh Token
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <h5 class="mb-3">How it works</h5>
                    <div class="steps">
                        <div class="step-item mb-3">
                            <div class="step-number">1</div>
                            <div class="step-content">
                                <strong>Generate Token</strong>
                                <p class="text-muted small mb-0">Create a secure token for volunteer check-ins</p>
                            </div>
                        </div>
                        <div class="step-item mb-3">
                            <div class="step-number">2</div>
                            <div class="step-content">
                                <strong>Display QR Code</strong>
                                <p class="text-muted small mb-0">Volunteers scan the code using their phones</p>
                            </div>
                        </div>
                        <div class="step-item">
                            <div class="step-number">3</div>
                            <div class="step-content">
                                <strong>Automatic Attendance</strong>
                                <p class="text-muted small mb-0">Attendance is recorded against their booking automatically</p>
                            </div>
                        </div>
                    </div>
                    
                    {% if not time_slot %}
                    <div class="alert alert-info mt-4">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Tip:</strong> For specific time slots, access this page via the time slot management view.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</section>

<style>
.step-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
}
.step-number {
    width: 28px;
    height: 28px;
    background: #007bff;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: 600;
    flex-shrink: 0;
}
.step-content {
    flex: 1;
}
</style>
{% endblock %}

{% block extra_js %}
<!-- Local QR rendering library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
(function(){
    const TTL_FALLBACK = 30;
    const rootEl = document.querySelector('section.container[data-event-id]');
    const eventId = rootEl ? parseInt(rootEl.getAttribute('data-event-id'), 10) : null;
    const tsRaw = rootEl ? rootEl.getAttribute('data-time-slot-id') : '';
    const timeSlotId = tsRaw ? parseInt(tsRaw, 10) : null;
    const qrImg = document.getElementById('qr-img');
    const qrCanvas = document.getElementById('qr-canvas');
    const ttlSpan = document.getElementById('ttl');
    const btnRefresh = document.getElementById('btn-refresh');
    let remaining = 0;
    let timer = null;
    let currentToken = null;

    function getAttendUrl(token){
        return `${window.location.origin}/attend?t=${encodeURIComponent(token)}`;
    }

    function tick(){
        ttlSpan.textContent = remaining;
        remaining -= 1;
        if (remaining < 0) {
            fetchToken();
        }
    }

    function startTimer(ttl){
        if (timer) clearInterval(timer);
        remaining = ttl || TTL_FALLBACK;
        timer = setInterval(tick, 1000);
    }

    async function fetchToken(){
        try {
            const csrf = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
            const res = await fetch('/api/attendance/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrf
                },
                body: JSON.stringify({ event_id: eventId, time_slot_id: timeSlotId })
            });
            const data = await res.json();
            if (data.error){
                showAlert('Failed to generate token: ' + data.error, 'danger');
                return;
            }
            currentToken = data.token;
            // Render locally
            try {
                if (qrCanvas) {
                    qrCanvas.innerHTML = '';
                    new QRCode(qrCanvas, {
                        text: getAttendUrl(currentToken),
                        width: 260,
                        height: 260,
                        correctLevel: QRCode.CorrectLevel.M
                    });
                }
            } catch (e) {
                // Fallback to image-based QR if library fails
                if (qrImg) {
                    const imgUrl = `https://api.qrserver.com/v1/create-qr-code/?size=280x280&data=${encodeURIComponent(getAttendUrl(currentToken))}`;
                    qrImg.src = imgUrl;
                    qrImg.classList.remove('d-none');
                }
            }
            const ttl = (data && data.ttl_minutes) ? (data.ttl_minutes * 60) : TTL_FALLBACK;
            startTimer(ttl);
            showAlert('QR token generated successfully!', 'success');
        } catch (e){
            showAlert('Error generating token: ' + e.message, 'danger');
        }
    }

    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('.card-body').insertBefore(alertDiv, document.querySelector('.card-body').firstChild);
        setTimeout(() => alertDiv.remove(), 5000);
    }

    btnRefresh.addEventListener('click', (e)=>{
        e.preventDefault();
        fetchToken();
    });

    // Initialize on load
    fetchToken();
})();
</script>
{% endblock %}